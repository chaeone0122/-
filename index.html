<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›”ê¸‰ ìì‚°ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0f0f0f; color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 28px; font-weight: 700; color: #5DADE2; }
        .user-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 10px; font-size: 14px; color: #888; }
        .user-name { color: #5DADE2; font-weight: 600; }
        .logout-btn { background: #333; border: none; padding: 6px 12px; border-radius: 6px; color: #888; font-size: 12px; cursor: pointer; }
        .logout-btn:hover { background: #444; color: #fff; }
        .exchange-rate { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; font-size: 14px; color: #888; }
        .exchange-rate .rate { color: #4ade80; font-weight: 600; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #1a1a1a; border-radius: 16px; padding: 24px; border: 1px solid #2a2a2a; }
        .card-title { font-size: 16px; color: #fff; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; }
        .card-title .badge { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #aaa; }

        /* ë¡œê·¸ì¸ */
        .auth-container { max-width: 400px; margin: 100px auto; display: none; }
        .auth-card { background: #1a1a1a; border-radius: 20px; padding: 40px; border: 1px solid #2a2a2a; }
        .auth-title { text-align: center; font-size: 24px; font-weight: 700; color: #5DADE2; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; font-size: 14px; color: #888; margin-bottom: 32px; }
        .auth-input-group { margin-bottom: 16px; }
        .auth-label { display: block; font-size: 12px; color: #888; margin-bottom: 8px; }
        .auth-input { width: 100%; background: #252525; border: 1px solid #333; border-radius: 10px; padding: 14px; color: #fff; font-size: 14px; }
        .auth-input:focus { outline: none; border-color: #5DADE2; }
        .auth-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .auth-btn.primary { background: #5DADE2; color: #fff; }
        .auth-btn.primary:hover { background: #3498DB; }
        .auth-btn.secondary { background: transparent; border: 1px solid #333; color: #888; }
        .auth-btn.secondary:hover { border-color: #5DADE2; color: #5DADE2; }
        .auth-divider { text-align: center; color: #666; font-size: 12px; margin: 20px 0; }
        .auth-error { background: #3d1f1f; border: 1px solid #ef4444; color: #ef4444; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; display: none; }
        .auth-success { background: #1f3d1f; border: 1px solid #4ade80; color: #4ade80; padding: 12px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; display: none; }

        /* ë¡œë”© */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f0f; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: #5DADE2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .app-container { display: none; }

        /* ì›”ê¸‰ ì…ë ¥ */
        .salary-input-group { display: flex; gap: 12px; align-items: center; }
        .salary-input { flex: 1; background: #252525; border: 2px solid #333; border-radius: 12px; padding: 16px 20px; font-size: 24px; font-weight: 700; color: #fff; text-align: right; }
        .salary-input:focus { outline: none; border-color: #5DADE2; }
        .won { font-size: 20px; color: #888; }

        /* ë¹„ìœ¨ */
        .ratio-section { margin-top: 24px; }
        .ratio-item { margin-bottom: 20px; }
        .ratio-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .ratio-label { font-size: 14px; color: #ccc; }
        .ratio-value { font-size: 14px; font-weight: 600; }
        .ratio-value-input { width: 70px; background: transparent; border: 1px solid transparent; border-radius: 6px; padding: 4px 8px; font-size: 14px; font-weight: 600; text-align: right; color: inherit; }
        .ratio-value-input:hover { background: #333; border-color: #444; }
        .ratio-value-input:focus { outline: none; background: #333; border-color: #5DADE2; }
        .ratio-value-input.invest { color: #5DADE2; }
        .ratio-value-input.saving { color: #4ade80; }
        .ratio-value.invest { color: #5DADE2; }
        .ratio-value.saving { color: #4ade80; }
        .ratio-value.living { color: #f59e0b; }
        .ratio-slider { width: 100%; height: 8px; border-radius: 4px; -webkit-appearance: none; background: #333; }
        .ratio-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; }
        .ratio-slider.invest::-webkit-slider-thumb { background: #5DADE2; }
        .ratio-slider.saving::-webkit-slider-thumb { background: #4ade80; }
        .ratio-amounts { display: flex; justify-content: space-between; margin-top: 4px; font-size: 12px; color: #666; }

        /* íˆ¬ì ì¢…ëª© */
        .stock-list { display: flex; flex-direction: column; gap: 12px; }
        .stock-item { display: flex; align-items: center; gap: 12px; background: #252525; padding: 14px 16px; border-radius: 12px; }
        .stock-item:hover { background: #2a2a2a; }
        .stock-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
        .stock-icon.btc { background: linear-gradient(135deg, #f7931a, #ffab40); }
        .stock-icon.tsla { background: linear-gradient(135deg, #cc0000, #ff4444); }
        .stock-icon.pltr { background: linear-gradient(135deg, #1a1a2e, #16213e); border: 1px solid #333; }
        .stock-icon.nvda { background: linear-gradient(135deg, #76b900, #a3d900); color: #000; }
        .stock-icon.sp500 { background: linear-gradient(135deg, #1a5f7a, #57c5b6); }
        .stock-icon.qqq { background: linear-gradient(135deg, #5c469c, #d4a5ff); }
        .stock-icon.default { background: linear-gradient(135deg, #444, #666); }
        .stock-info { flex: 1; }
        .stock-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .stock-percent { font-size: 12px; color: #888; }
        .stock-amount { text-align: right; }
        .stock-krw { font-size: 14px; font-weight: 600; }
        .stock-usd { font-size: 12px; color: #4ade80; }
        .stock-percent-input { width: 60px; background: #333; border: none; border-radius: 8px; padding: 8px; text-align: center; color: #fff; font-size: 14px; }
        .stock-delete { background: none; border: none; color: #666; cursor: pointer; padding: 8px; font-size: 18px; }
        .stock-delete:hover { color: #ef4444; }
        .add-stock-btn { width: 100%; padding: 14px; background: transparent; border: 2px dashed #333; border-radius: 12px; color: #666; font-size: 14px; cursor: pointer; }
        .add-stock-btn:hover { border-color: #5DADE2; color: #5DADE2; }

        /* íƒ­ */
        .tab-container { display: flex; gap: 4px; margin-bottom: 20px; background: #252525; padding: 4px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px 12px; background: transparent; border: none; border-radius: 8px; color: #888; font-size: 13px; cursor: pointer; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { background: #333; color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-header { display: flex; justify-content: flex-end; margin-bottom: 12px; }

        /* ë²„íŠ¼ */
        .purchase-complete-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 16px; }
        .purchase-complete-btn.invest { background: #5DADE2; color: #fff; }
        .purchase-complete-btn.saving { background: #4ade80; color: #000; }
        .purchase-complete-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* ìš”ì•½ */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        @media (max-width: 700px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
        .summary-item { background: #252525; padding: 20px; border-radius: 12px; text-align: center; }
        .summary-label { font-size: 12px; color: #888; margin-bottom: 8px; }
        .summary-value { font-size: 20px; font-weight: 700; }
        .summary-value.total { color: #fff; }
        .summary-value.invest { color: #5DADE2; }
        .summary-value.saving { color: #4ade80; }
        .summary-value.usd { color: #f59e0b; }

        /* ìˆ˜ê¸° ì…ë ¥ */
        .manual-entry-form { display: flex; flex-direction: column; gap: 12px; }
        .manual-row { display: flex; gap: 12px; }
        .manual-field { flex: 1; }
        .manual-label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .manual-input { width: 100%; background: #252525; border: 1px solid #333; border-radius: 8px; padding: 12px; color: #fff; font-size: 14px; }
        .manual-input:focus { outline: none; border-color: #5DADE2; }
        .manual-submit-btn { width: 100%; padding: 14px; background: #5DADE2; border: none; border-radius: 10px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        @media (max-width: 600px) { .manual-row { flex-direction: column; } }

        /* ì ê¸ˆ */
        .saving-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: #252525; border-radius: 12px; margin-bottom: 10px; }
        .saving-info { display: flex; align-items: center; gap: 12px; }
        .saving-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #4ade80, #22c55e); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .saving-name { font-size: 14px; font-weight: 500; }
        .saving-amount { font-size: 14px; font-weight: 600; color: #4ade80; }

        /* ì›”ë³„ ê¸°ë¡ */
        .month-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 8px; }
        .month-tab { padding: 10px 20px; background: #252525; border: none; border-radius: 10px; color: #888; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .month-tab:hover { background: #333; }
        .month-tab.active { background: #5DADE2; color: #fff; }
        .record-table { width: 100%; border-collapse: collapse; }
        .record-table th, .record-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #2a2a2a; }
        .record-table th { font-size: 12px; font-weight: 500; color: #888; }
        .record-table td { font-size: 14px; }
        .record-table .date { color: #888; }
        .record-table .type-invest { color: #5DADE2; }
        .record-table .type-saving { color: #4ade80; }

        /* ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a1a; border-radius: 20px; padding: 28px; width: 90%; max-width: 400px; border: 1px solid #2a2a2a; }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 16px; }
        .modal-label { display: block; font-size: 12px; color: #888; margin-bottom: 8px; }
        .modal-input { width: 100%; background: #252525; border: 1px solid #333; border-radius: 10px; padding: 14px; color: #fff; font-size: 14px; }
        .modal-input:focus { outline: none; border-color: #5DADE2; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn.cancel { background: #333; border: none; color: #fff; }
        .modal-btn.confirm { background: #5DADE2; border: none; color: #fff; }

        /* ì´í•© ë°” */
        .total-bar { background: #252525; border-radius: 8px; height: 10px; overflow: hidden; margin-top: 16px; display: flex; }
        .total-bar .invest-bar { background: #5DADE2; height: 100%; }
        .percent-warning { color: #ef4444; font-size: 12px; margin-top: 8px; }

        /* ì¢…ëª©ë³„ í˜„í™© */
        .item-stats-section { margin-bottom: 30px; }
        .item-stats-title { font-size: 14px; color: #5DADE2; margin-bottom: 16px; font-weight: 600; }
        .item-stats-title.saving-title { color: #4ade80; }
        .bar-chart-item { margin-bottom: 16px; }
        .bar-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .bar-chart-name { font-size: 14px; color: #fff; font-weight: 500; }
        .bar-chart-amount { font-size: 14px; color: #fff; font-weight: 600; }
        .bar-chart-track { height: 24px; background: #252525; border-radius: 12px; overflow: hidden; }
        .bar-chart-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; }
        .bar-chart-fill.invest { background: linear-gradient(90deg, #5DADE2, #3498DB); }
        .bar-chart-fill.saving { background: linear-gradient(90deg, #4ade80, #22c55e); }
        .bar-chart-percent { font-size: 11px; color: #fff; font-weight: 600; }
        .bar-chart-usd { font-size: 12px; color: #888; margin-top: 4px; }
        .stats-total { display: flex; justify-content: space-between; padding: 16px; background: #252525; border-radius: 12px; margin-top: 12px; }
        .stats-total-label { font-size: 14px; color: #888; }
        .stats-total-value { font-size: 16px; font-weight: 700; }
        .stats-total-value.invest { color: #5DADE2; }
        .stats-total-value.saving { color: #4ade80; }
        .no-data-message { text-align: center; padding: 40px; color: #666; font-size: 14px; }

        /* ========== ëª¨ë°”ì¼ ìµœì í™” ========== */
        @media (max-width: 480px) {
            body { padding: 12px; }
            
            /* í—¤ë” */
            header h1 { font-size: 22px; }
            .user-info { flex-wrap: wrap; gap: 8px; font-size: 13px; }
            .exchange-rate { font-size: 13px; }
            
            /* ì¹´ë“œ */
            .card { padding: 16px; border-radius: 12px; }
            .card-title { font-size: 14px; margin-bottom: 12px; }
            
            /* ì›”ê¸‰ ì…ë ¥ */
            .salary-input { font-size: 20px; padding: 12px 14px; }
            .won { font-size: 16px; }
            
            /* ë¹„ìœ¨ ìŠ¬ë¼ì´ë” */
            .ratio-section { margin-top: 16px; }
            .ratio-item { margin-bottom: 16px; }
            .ratio-label { font-size: 13px; }
            .ratio-value-input { width: 65px; font-size: 13px; padding: 3px 6px; }
            .ratio-amounts { font-size: 11px; }
            .ratio-slider::-webkit-slider-thumb { width: 24px; height: 24px; }
            
            /* íƒ­ */
            .tab-container { gap: 2px; padding: 3px; }
            .tab-btn { padding: 10px 8px; font-size: 12px; }
            
            /* íˆ¬ì ì¢…ëª© ë¦¬ìŠ¤íŠ¸ */
            .stock-item { padding: 12px; gap: 10px; flex-wrap: wrap; }
            .stock-icon { width: 36px; height: 36px; font-size: 14px; border-radius: 8px; }
            .stock-name { font-size: 13px; }
            .stock-percent { font-size: 11px; }
            .stock-krw { font-size: 13px; }
            .stock-usd { font-size: 11px; }
            .stock-percent-input { width: 50px; padding: 6px; font-size: 13px; }
            .stock-delete { padding: 6px; font-size: 16px; }
            .add-stock-btn { padding: 12px; font-size: 13px; }
            
            /* ì ê¸ˆ í•­ëª© */
            .saving-item { padding: 12px; }
            .saving-icon { width: 32px; height: 32px; }
            .saving-name { font-size: 13px; }
            .saving-amount { font-size: 13px; }
            
            /* ë²„íŠ¼ */
            .purchase-complete-btn { padding: 14px; font-size: 14px; }
            
            /* ìš”ì•½ ê·¸ë¦¬ë“œ */
            .summary-grid { gap: 10px; }
            .summary-item { padding: 14px 10px; }
            .summary-label { font-size: 11px; }
            .summary-value { font-size: 16px; }
            
            /* ìˆ˜ê¸° ì…ë ¥ */
            .manual-row { flex-direction: column; gap: 10px; }
            .manual-label { font-size: 11px; }
            .manual-input { padding: 10px; font-size: 14px; }
            .manual-submit-btn { padding: 12px; font-size: 14px; }
            
            /* ========== ì›”ë³„ íƒ­ ìµœì í™” ========== */
            .month-tabs { 
                gap: 6px; 
                margin-bottom: 16px;
                padding-bottom: 10px;
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
            }
            .month-tab { 
                padding: 8px 12px; 
                font-size: 12px;
                flex-shrink: 0;
            }
            
            /* ========== í…Œì´ë¸” ëª¨ë°”ì¼ ìµœì í™” ========== */
            .record-table-wrapper { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
                margin: 0 -16px;
                padding: 0 16px;
                scrollbar-width: thin;
            }
            .record-table { 
                min-width: 480px;
                font-size: 12px;
            }
            .record-table th, .record-table td { 
                padding: 10px 6px; 
                font-size: 11px; 
                white-space: nowrap;
            }
            .record-table th:first-child,
            .record-table td:first-child { padding-left: 0; }
            .record-table th:last-child,
            .record-table td:last-child { 
                padding-right: 0;
                width: 30px;
            }
            /* ì‚­ì œ ë²„íŠ¼ */
            .record-table td button {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            /* ========== ì¢…ëª©ë³„ í˜„í™© ìµœì í™” ========== */
            .item-stats-section { margin-bottom: 20px; }
            .item-stats-title { 
                font-size: 12px; 
                margin-bottom: 12px;
            }
            .bar-chart-item { margin-bottom: 12px; }
            .bar-chart-header { margin-bottom: 6px; }
            .bar-chart-name { font-size: 12px; }
            .bar-chart-amount { font-size: 12px; }
            .bar-chart-track { height: 18px; border-radius: 9px; }
            .bar-chart-fill { 
                padding-right: 6px;
                border-radius: 9px;
            }
            .bar-chart-percent { font-size: 9px; }
            .bar-chart-usd { font-size: 10px; margin-top: 2px; }
            .stats-total { 
                padding: 10px 12px; 
                margin-top: 8px;
                border-radius: 10px;
            }
            .stats-total-label { font-size: 12px; }
            .stats-total-value { font-size: 13px; }
            .no-data-message { 
                padding: 24px; 
                font-size: 12px; 
            }
            
            /* ëª¨ë‹¬ */
            .modal { padding: 20px; width: 95%; }
            .modal-title { font-size: 16px; }
            .modal-input { padding: 12px; font-size: 14px; }
            .modal-btn { padding: 12px; font-size: 14px; }
            
            /* ë¡œê·¸ì¸ */
            .auth-container { margin: 60px auto; padding: 0 12px; }
            .auth-card { padding: 28px 20px; }
            .auth-title { font-size: 20px; }
            .auth-subtitle { font-size: 13px; }
            .auth-input { padding: 12px; font-size: 14px; }
            .auth-btn { padding: 12px; font-size: 14px; }
        }
        
        /* ì•„ì£¼ ì‘ì€ í™”ë©´ (SE ë“±) */
        @media (max-width: 360px) {
            body { padding: 10px; }
            header h1 { font-size: 20px; }
            .salary-input { font-size: 18px; }
            .card { padding: 12px; }
            .summary-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .summary-item { padding: 12px 8px; }
            .summary-value { font-size: 14px; }
            .tab-btn { padding: 8px 6px; font-size: 11px; }
            .stock-item { padding: 10px; }
            .stock-icon { width: 32px; height: 32px; font-size: 12px; }
            
            /* ì›”ë³„ íƒ­ ë” ì‘ê²Œ */
            .month-tabs {
                margin-left: -12px;
                margin-right: -12px;
                padding-left: 12px;
                padding-right: 12px;
            }
            .month-tab { padding: 6px 10px; font-size: 11px; }
            
            /* í…Œì´ë¸” ë” ì‘ê²Œ */
            .record-table-wrapper {
                margin: 0 -12px;
                padding: 0 12px;
            }
            .record-table { min-width: 420px; }
            .record-table th, .record-table td { 
                padding: 8px 4px; 
                font-size: 10px; 
            }
            
            /* ì¢…ëª©ë³„ í˜„í™© ë” ì‘ê²Œ */
            .bar-chart-name { font-size: 11px; }
            .bar-chart-amount { font-size: 11px; }
            .bar-chart-track { height: 16px; }
            .bar-chart-percent { font-size: 8px; }
            .stats-total { padding: 8px 10px; }
            .stats-total-label { font-size: 11px; }
            .stats-total-value { font-size: 12px; }
        }

        /* í…Œì´ë¸” ë˜í¼ */
        .record-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- ë¡œê·¸ì¸ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <h1 class="auth-title">ğŸ’° ì›”ê¸‰ ìì‚°ê´€ë¦¬</h1>
            <p class="auth-subtitle">ë¡œê·¸ì¸í•˜ì—¬ ìì‚°ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>
            
            <div id="loginForm">
                <div class="auth-input-group">
                    <label class="auth-label">ì•„ì´ë””</label>
                    <input type="text" class="auth-input" id="loginUsername" placeholder="ì•„ì´ë”” ì…ë ¥">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="auth-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
                <button class="auth-btn primary" onclick="login()">ë¡œê·¸ì¸</button>
                <div class="auth-divider">ë˜ëŠ”</div>
                <button class="auth-btn secondary" onclick="showSignup()">íšŒì›ê°€ì…</button>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div class="auth-input-group">
                    <label class="auth-label">ì•„ì´ë””</label>
                    <input type="text" class="auth-input" id="signupUsername" placeholder="ì•„ì´ë”” (ì˜ˆ: chae1)">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">ì´ë¦„ (ì„ íƒ)</label>
                    <input type="text" class="auth-input" id="signupName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì±„ì›)">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" class="auth-input" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" class="auth-input" id="signupPasswordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                </div>
                <button class="auth-btn primary" onclick="signup()">íšŒì›ê°€ì…</button>
                <div class="auth-divider">ë˜ëŠ”</div>
                <button class="auth-btn secondary" onclick="showLogin()">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div class="app-container" id="appContainer">
        <div class="container">
            <header>
                <h1>ğŸ’° ì›”ê¸‰ ìì‚°ê´€ë¦¬</h1>
                <div class="user-info">
                    <span>ğŸ‘‹ <span class="user-name" id="userName">ì‚¬ìš©ì</span>ë‹˜</span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <div class="exchange-rate">
                    <span>USD/KRW:</span>
                    <span class="rate" id="exchangeRate">ë¡œë”©ì¤‘...</span>
                </div>
            </header>

            <!-- 1ì¤„: ì›”ê¸‰ ì„¤ì • & íˆ¬ì/ì ê¸ˆ -->
            <div class="grid">
                <div class="card">
                    <div class="card-title">ì›”ê¸‰ ì„¤ì •</div>
                    <div class="salary-input-group">
                        <input type="text" class="salary-input" id="salaryInput" value="3,200,000">
                        <span class="won">ì›</span>
                    </div>
                    <div class="ratio-section">
                        <div class="ratio-item">
                            <div class="ratio-header">
                                <span class="ratio-label">ğŸ’ íˆ¬ì ë¹„ìœ¨</span>
                                <input type="text" class="ratio-value-input invest" id="investRatioValue" value="18.75%">
                            </div>
                            <input type="range" class="ratio-slider invest" id="investRatio" min="0" max="100" step="0.01" value="18.75">
                            <div class="ratio-amounts"><span>0ì›</span><span id="investAmount">600,000ì›</span></div>
                        </div>
                        <div class="ratio-item">
                            <div class="ratio-header">
                                <span class="ratio-label">ğŸ¦ ì ê¸ˆ ë¹„ìœ¨</span>
                                <input type="text" class="ratio-value-input saving" id="savingRatioValue" value="9.375%">
                            </div>
                            <input type="range" class="ratio-slider saving" id="savingRatio" min="0" max="100" step="0.01" value="9.375">
                            <div class="ratio-amounts"><span>0ì›</span><span id="savingAmount">300,000ì›</span></div>
                        </div>
                        <div class="ratio-item">
                            <div class="ratio-header">
                                <span class="ratio-label">ğŸ›’ ìƒí™œë¹„</span>
                                <span class="ratio-value living" id="livingRatioValue">71.875%</span>
                            </div>
                            <div class="ratio-amounts"><span></span><span id="livingAmount">2,300,000ì›</span></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="tab-container">
                        <button class="tab-btn active" data-tab="invest" onclick="switchTab('invest')">ğŸ’ íˆ¬ìì¢…ëª©</button>
                        <button class="tab-btn" data-tab="saving" onclick="switchTab('saving')">ğŸ¦ ì ê¸ˆí•­ëª©</button>
                    </div>
                    <div class="tab-content active" id="investTab">
                        <div class="tab-header"><span class="badge" id="stockTotalPercent">ì´ 600,000ì›</span></div>
                        <div class="stock-list" id="stockList"></div>
                        <div class="total-bar" id="stockTotalBar"><div class="invest-bar" style="width: 100%"></div></div>
                        <p class="percent-warning" id="stockWarning" style="display: none;">âš ï¸ ì¢…ëª© í¼ì„¼íŠ¸ í•©ì´ 100%ê°€ ì•„ë‹™ë‹ˆë‹¤</p>
                        <button class="add-stock-btn" onclick="openStockModal()">+ ì¢…ëª© ì¶”ê°€</button>
                        <button class="purchase-complete-btn invest" onclick="completePurchase('invest')">ğŸ’ ì´ë²ˆ ë‹¬ íˆ¬ì ë§¤ìˆ˜ì™„ë£Œ</button>
                    </div>
                    <div class="tab-content" id="savingTab">
                        <div class="tab-header"><span class="badge" id="savingTotalPercent">ì´ 300,000ì›</span></div>
                        <div id="savingList"></div>
                        <button class="add-stock-btn" onclick="openSavingModal()">+ ì ê¸ˆ ì¶”ê°€</button>
                        <button class="purchase-complete-btn saving" onclick="completePurchase('saving')">ğŸ¦ ì´ë²ˆ ë‹¬ ì ê¸ˆ ì™„ë£Œ</button>
                    </div>
                </div>
            </div>

            <!-- 2ì¤„: ì—°ê°„ìš”ì•½ & ìˆ˜ê¸°ì…ë ¥ -->
            <div class="grid">
                <div class="card">
                    <div class="card-title">ğŸ“Š <span id="currentYear">2026</span>ë…„ ì—°ê°„ ìš”ì•½</div>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="summary-label">ì´ ì €ì¶•</div><div class="summary-value total" id="yearTotalSaved">0ì›</div></div>
                        <div class="summary-item"><div class="summary-label">ì´ íˆ¬ì</div><div class="summary-value invest" id="yearTotalInvest">0ì›</div></div>
                        <div class="summary-item"><div class="summary-label">ì´ ì ê¸ˆ</div><div class="summary-value saving" id="yearTotalSaving">0ì›</div></div>
                        <div class="summary-item"><div class="summary-label">USD íˆ¬ì</div><div class="summary-value usd" id="yearTotalUSD">$0</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">âœï¸ ìˆ˜ê¸° íˆ¬ì/ì ê¸ˆ ì…ë ¥</div>
                    <div class="manual-entry-form">
                        <div class="manual-row">
                            <div class="manual-field"><label class="manual-label">ë‚ ì§œ</label><input type="date" class="manual-input" id="manualDate"></div>
                            <div class="manual-field"><label class="manual-label">êµ¬ë¶„</label><select class="manual-input" id="manualType" onchange="updateManualItemSelect()"><option value="stock">ì£¼ì‹</option><option value="coin">ì½”ì¸</option><option value="saving">ì ê¸ˆ</option></select></div>
                        </div>
                        <div class="manual-row">
                            <div class="manual-field"><label class="manual-label">ì¢…ëª©/í•­ëª©</label><div id="manualItemWrapper"><select class="manual-input" id="manualItem" onchange="checkCustomInput()"></select></div></div>
                            <div class="manual-field"><label class="manual-label">ê¸ˆì•¡ (ì›)</label><input type="number" class="manual-input" id="manualAmount" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>
                        </div>
                        <div class="manual-row">
                            <div class="manual-field"><label class="manual-label">ë©”ëª¨ (ì„ íƒ)</label><input type="text" class="manual-input" id="manualMemo" placeholder="ë©”ëª¨ ì…ë ¥"></div>
                        </div>
                        <button class="manual-submit-btn" onclick="addManualRecord()">âœï¸ ìˆ˜ê¸° ê¸°ë¡ ì¶”ê°€</button>
                    </div>
                </div>
            </div>

            <!-- 3ì¤„: ì›”ë³„ê¸°ë¡ & ì¢…ëª©ë³„í˜„í™© -->
            <div class="grid">
                <div class="card">
                    <div class="card-title">ğŸ“… ì›”ë³„ íˆ¬ì/ì ê¸ˆ ê¸°ë¡</div>
                    <div class="month-tabs" id="monthTabs"></div>
                    <div class="record-table-wrapper">
                        <table class="record-table">
                            <thead><tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ì¢…ëª©</th><th>ê¸ˆì•¡</th><th>ë©”ëª¨</th><th></th></tr></thead>
                            <tbody id="recordTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">ğŸ“Š ì¢…ëª©ë³„ í˜„í™©</div>
                    <div id="itemStatsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div class="modal-overlay" id="stockModal">
        <div class="modal">
            <div class="modal-title">íˆ¬ì ì¢…ëª© ì¶”ê°€</div>
            <div class="modal-input-group"><label class="modal-label">ì¢…ëª©ëª…</label><input type="text" class="modal-input" id="newStockName" placeholder="ì˜ˆ: ì• í”Œ"></div>
            <div class="modal-input-group"><label class="modal-label">íˆ¬ì ë¹„ìœ¨ (%)</label><input type="number" class="modal-input" id="newStockPercent" placeholder="ì˜ˆ: 10" min="0" max="100"></div>
            <div class="modal-buttons"><button class="modal-btn cancel" onclick="closeStockModal()">ì·¨ì†Œ</button><button class="modal-btn confirm" onclick="addStock()">ì¶”ê°€</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="savingModal">
        <div class="modal">
            <div class="modal-title">ì ê¸ˆ í•­ëª© ì¶”ê°€</div>
            <div class="modal-input-group"><label class="modal-label">í•­ëª©ëª…</label><input type="text" class="modal-input" id="newSavingName" placeholder="ì˜ˆ: ë¹„ìƒê¸ˆ"></div>
            <div class="modal-input-group"><label class="modal-label">ê¸ˆì•¡ (ì›)</label><input type="number" class="modal-input" id="newSavingAmount" placeholder="ì˜ˆ: 100000"></div>
            <div class="modal-buttons"><button class="modal-btn cancel" onclick="closeSavingModal()">ì·¨ì†Œ</button><button class="modal-btn confirm" onclick="addSaving()">ì¶”ê°€</button></div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://sqhjnurqeuytvbziuwin.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxaGpudXJxZXV5dHZieml1d2luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODI0NDcsImV4cCI6MjA4MzE1ODQ0N30.pjBJOHV0IHv3CPAywwPx0rYtRx3FEtqcA975WueNCbg';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let state = { salary: 3200000, investRatio: 18.75, savingRatio: 9.375, exchangeRate: 1450, stocks: [], savings: [], records: [], selectedMonth: new Date().getMonth() + 1 };

        // ì¸ì¦
        async function checkAuth() {
            const saved = localStorage.getItem('salary_app_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                await loadUserData();
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            updateUI();
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('authError').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('authError').style.display = 'none';
        }

        function showError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { showError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            const { data, error } = await db.from('users').select('*').eq('username', username).eq('password', password).single();
            if (error || !data) { showError('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

            currentUser = data;
            localStorage.setItem('salary_app_user', JSON.stringify(data));
            await loadUserData();
            showApp();
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const name = document.getElementById('signupName').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupPasswordConfirm').value;

            if (!username || !password) { showError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (username.length < 2) { showError('ì•„ì´ë””ëŠ” 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
            if (password.length < 4) { showError('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
            if (password !== confirm) { showError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

            const { data: exists } = await db.from('users').select('id').eq('username', username).single();
            if (exists) { showError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); return; }

            const { data: newUser, error } = await db.from('users').insert({ username, password, name: name || username }).select().single();
            if (error) { showError('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); return; }

            await db.from('salary_settings').insert({ user_id: newUser.id, salary: 3200000, invest_ratio: 18.75, saving_ratio: 9.375, exchange_rate: 1450 });
            await db.from('stocks').insert([
                { user_id: newUser.id, name: 'ë¹„íŠ¸ì½”ì¸', percent: 15, icon: 'btc', sort_order: 1 },
                { user_id: newUser.id, name: 'í…ŒìŠ¬ë¼', percent: 15, icon: 'tsla', sort_order: 2 },
                { user_id: newUser.id, name: 'íŒ”ë€í‹°ì–´', percent: 10, icon: 'pltr', sort_order: 3 },
                { user_id: newUser.id, name: 'ì—”ë¹„ë””ì•„', percent: 10, icon: 'nvda', sort_order: 4 },
                { user_id: newUser.id, name: 'ë¯¸êµ­ S&P500', percent: 25, icon: 'sp500', sort_order: 5 },
                { user_id: newUser.id, name: 'ë¯¸êµ­ QQQ', percent: 25, icon: 'qqq', sort_order: 6 }
            ]);
            await db.from('savings').insert([
                { user_id: newUser.id, name: 'ì£¼íƒì²­ì•½', amount: 100000, sort_order: 1 },
                { user_id: newUser.id, name: 'ê²½ì¡°ì‚¬ë¹„', amount: 100000, sort_order: 2 },
                { user_id: newUser.id, name: 'ììœ ì ê¸ˆ', amount: 100000, sort_order: 3 }
            ]);

            currentUser = newUser;
            localStorage.setItem('salary_app_user', JSON.stringify(newUser));
            await loadUserData();
            showApp();
        }

        function logout() {
            localStorage.removeItem('salary_app_user');
            currentUser = null;
            showAuth();
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadUserData() {
            if (!currentUser) return;
            const { data: settings } = await db.from('salary_settings').select('*').eq('user_id', currentUser.id).single();
            if (settings) {
                state.salary = settings.salary;
                state.investRatio = parseFloat(settings.invest_ratio);
                state.savingRatio = parseFloat(settings.saving_ratio);
                state.exchangeRate = parseFloat(settings.exchange_rate);
            }
            const { data: stocks } = await db.from('stocks').select('*').eq('user_id', currentUser.id).order('sort_order');
            if (stocks) state.stocks = stocks.map(s => ({ id: s.id, name: s.name, percent: parseFloat(s.percent), icon: s.icon }));
            const { data: savings } = await db.from('savings').select('*').eq('user_id', currentUser.id).order('sort_order');
            if (savings) state.savings = savings.map(s => ({ id: s.id, name: s.name, amount: s.amount }));
            const { data: records } = await db.from('records').select('*').eq('user_id', currentUser.id).order('date', { ascending: false });
            if (records) state.records = records.map(r => ({ id: r.id, date: r.date, type: r.type, item: r.item, amount: r.amount, rate: r.rate ? parseFloat(r.rate) : null, memo: r.memo }));
            fetchExchangeRate();
        }

        async function saveSettings() {
            if (!currentUser) return;
            await db.from('salary_settings').update({ salary: state.salary, invest_ratio: state.investRatio, saving_ratio: state.savingRatio, exchange_rate: state.exchangeRate }).eq('user_id', currentUser.id);
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                state.exchangeRate = data.rates.KRW;
                document.getElementById('exchangeRate').textContent = `â‚©${formatNumber(Math.round(state.exchangeRate))}`;
                saveSettings();
            } catch (e) {
                document.getElementById('exchangeRate').textContent = `â‚©${formatNumber(state.exchangeRate)}`;
            }
        }

        // ìœ í‹¸
        function formatNumber(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
        function parseNumber(s) { return parseInt(s.replace(/,/g, '')) || 0; }
        function calculateAmounts() {
            const investAmount = Math.round(state.salary * state.investRatio / 100);
            const savingAmount = Math.round(state.salary * state.savingRatio / 100);
            return { investAmount, savingAmount, livingAmount: state.salary - investAmount - savingAmount };
        }

        // UI
        function updateUI() {
            const { investAmount, savingAmount, livingAmount } = calculateAmounts();
            document.getElementById('investRatioValue').value = `${state.investRatio}%`;
            document.getElementById('savingRatioValue').value = `${state.savingRatio}%`;
            document.getElementById('livingRatioValue').textContent = `${(100 - state.investRatio - state.savingRatio).toFixed(2)}%`;
            document.getElementById('investAmount').textContent = `${formatNumber(investAmount)}ì›`;
            document.getElementById('savingAmount').textContent = `${formatNumber(savingAmount)}ì›`;
            document.getElementById('livingAmount').textContent = `${formatNumber(livingAmount)}ì›`;
            document.getElementById('investRatio').value = state.investRatio;
            document.getElementById('savingRatio').value = state.savingRatio;
            renderStocks(); renderSavings(); renderMonthTabs(); renderRecords(); renderItemStats(); updateYearlySummary(); updateManualItemSelect();
        }

        function renderStocks() {
            const { investAmount } = calculateAmounts();
            const el = document.getElementById('stockList');
            const total = state.stocks.reduce((s, x) => s + x.percent, 0);
            el.innerHTML = state.stocks.map(s => {
                const amt = Math.round(investAmount * s.percent / 100);
                const usd = (amt / state.exchangeRate).toFixed(2);
                return `<div class="stock-item"><div class="stock-icon ${s.icon||'default'}">${s.name.charAt(0)}</div><div class="stock-info"><div class="stock-name">${s.name}</div><div class="stock-percent">${s.percent}%</div></div><div class="stock-amount"><div class="stock-krw">${formatNumber(amt)}ì›</div><div class="stock-usd">$${formatNumber(parseFloat(usd))}</div></div><input type="number" class="stock-percent-input" value="${s.percent}" onchange="updateStockPercent('${s.id}',this.value)" min="0" max="100"><button class="stock-delete" onclick="deleteStock('${s.id}')">Ã—</button></div>`;
            }).join('');
            document.getElementById('stockTotalPercent').textContent = `ì´ ${formatNumber(investAmount)}ì›`;
            document.getElementById('stockTotalBar').querySelector('.invest-bar').style.width = `${Math.min(total,100)}%`;
            document.getElementById('stockWarning').style.display = total !== 100 ? 'block' : 'none';
        }

        function renderSavings() {
            const el = document.getElementById('savingList');
            const total = state.savings.reduce((s, x) => s + x.amount, 0);
            el.innerHTML = state.savings.map(s => `<div class="saving-item"><div class="saving-info"><div class="saving-icon">ğŸ¦</div><div class="saving-name">${s.name}</div></div><div style="display:flex;align-items:center;gap:8px"><span class="saving-amount">${formatNumber(s.amount)}ì›</span><button class="stock-delete" onclick="deleteSaving('${s.id}')">Ã—</button></div></div>`).join('');
            document.getElementById('savingTotalPercent').textContent = `ì´ ${formatNumber(total)}ì›`;
        }

        function renderMonthTabs() {
            const el = document.getElementById('monthTabs');
            el.innerHTML = Array.from({length:12},(_,i)=>i+1).map(m => `<button class="month-tab ${state.selectedMonth===m?'active':''}" onclick="selectMonth(${m})">${m}ì›”</button>`).join('');
        }

        function renderRecords() {
            const el = document.getElementById('recordTableBody');
            const year = new Date().getFullYear();
            const filtered = state.records.filter(r => { const d = new Date(r.date); return d.getMonth()+1 === state.selectedMonth && d.getFullYear() === year; });
            if (!filtered.length) { el.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;padding:40px">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
            el.innerHTML = filtered.map(r => `<tr><td class="date">${r.date}</td><td class="${r.type==='invest'?'type-invest':'type-saving'}">${r.type==='invest'?'íˆ¬ì':'ì ê¸ˆ'}</td><td>${r.item}</td><td>${formatNumber(r.amount)}ì›</td><td style="color:#888;font-size:12px">${r.memo||''}</td><td><button class="stock-delete" onclick="deleteRecord('${r.id}')">Ã—</button></td></tr>`).join('');
        }

        function renderItemStats() {
            const el = document.getElementById('itemStatsContent');
            const investStats = {}, savingStats = {};
            state.records.forEach(r => {
                if (r.type === 'invest') { if (!investStats[r.item]) investStats[r.item] = {amount:0,usd:0}; investStats[r.item].amount += r.amount; if (r.rate) investStats[r.item].usd += r.amount/r.rate; }
                else { if (!savingStats[r.item]) savingStats[r.item] = {amount:0}; savingStats[r.item].amount += r.amount; }
            });
            const investItems = Object.entries(investStats).sort((a,b)=>b[1].amount-a[1].amount);
            const savingItems = Object.entries(savingStats).sort((a,b)=>b[1].amount-a[1].amount);
            const totalInvest = investItems.reduce((s,[_,d])=>s+d.amount,0);
            const totalSaving = savingItems.reduce((s,[_,d])=>s+d.amount,0);
            if (!investItems.length && !savingItems.length) { el.innerHTML = '<div class="no-data-message">ğŸ“Š ì•„ì§ ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            let html = '';
            if (investItems.length) {
                html += `<div class="item-stats-section"><div class="item-stats-title">ğŸ’ íˆ¬ì ì¢…ëª©ë³„ í˜„í™©</div>${investItems.map(([n,d])=>{const p=totalInvest?(d.amount/totalInvest*100):0;return `<div class="bar-chart-item"><div class="bar-chart-header"><span class="bar-chart-name">${n}</span><span class="bar-chart-amount">${formatNumber(d.amount)}ì›</span></div><div class="bar-chart-track"><div class="bar-chart-fill invest" style="width:${p}%">${p>=10?`<span class="bar-chart-percent">${p.toFixed(1)}%</span>`:''}</div></div><div class="bar-chart-usd">$${formatNumber(d.usd.toFixed(2))}</div></div>`;}).join('')}<div class="stats-total"><span class="stats-total-label">ì´ íˆ¬ìê¸ˆì•¡</span><span class="stats-total-value invest">${formatNumber(totalInvest)}ì›</span></div></div>`;
            }
            if (savingItems.length) {
                html += `<div class="item-stats-section"><div class="item-stats-title saving-title">ğŸ¦ ì ê¸ˆ í•­ëª©ë³„ í˜„í™©</div>${savingItems.map(([n,d])=>{const p=totalSaving?(d.amount/totalSaving*100):0;return `<div class="bar-chart-item"><div class="bar-chart-header"><span class="bar-chart-name">${n}</span><span class="bar-chart-amount">${formatNumber(d.amount)}ì›</span></div><div class="bar-chart-track"><div class="bar-chart-fill saving" style="width:${p}%">${p>=10?`<span class="bar-chart-percent">${p.toFixed(1)}%</span>`:''}</div></div></div>`;}).join('')}<div class="stats-total"><span class="stats-total-label">ì´ ì ê¸ˆê¸ˆì•¡</span><span class="stats-total-value saving">${formatNumber(totalSaving)}ì›</span></div></div>`;
            }
            el.innerHTML = html;
        }

        function updateYearlySummary() {
            const year = new Date().getFullYear();
            const yr = state.records.filter(r => new Date(r.date).getFullYear() === year);
            const ti = yr.filter(r=>r.type==='invest').reduce((s,r)=>s+r.amount,0);
            const ts = yr.filter(r=>r.type==='saving').reduce((s,r)=>s+r.amount,0);
            const tu = yr.filter(r=>r.type==='invest'&&r.rate).reduce((s,r)=>s+r.amount/r.rate,0);
            document.getElementById('yearTotalSaved').textContent = `${formatNumber(ti+ts)}ì›`;
            document.getElementById('yearTotalInvest').textContent = `${formatNumber(ti)}ì›`;
            document.getElementById('yearTotalSaving').textContent = `${formatNumber(ts)}ì›`;
            document.getElementById('yearTotalUSD').textContent = `$${formatNumber(Math.round(tu))}`;
        }

        // ì´ë²¤íŠ¸
        function selectMonth(m) { state.selectedMonth = m; updateUI(); }
        async function updateStockPercent(id, v) { const s = state.stocks.find(x=>x.id===id); if(s){s.percent=parseFloat(v)||0; await db.from('stocks').update({percent:s.percent}).eq('id',id); updateUI();} }
        async function deleteStock(id) { state.stocks = state.stocks.filter(x=>x.id!==id); await db.from('stocks').delete().eq('id',id); updateUI(); }
        async function deleteSaving(id) { state.savings = state.savings.filter(x=>x.id!==id); await db.from('savings').delete().eq('id',id); updateUI(); }
        async function deleteRecord(id) { state.records = state.records.filter(x=>x.id!==id); await db.from('records').delete().eq('id',id); updateUI(); }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('active');if(b.dataset.tab===t)b.classList.add('active');});
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(t==='invest'?'investTab':'savingTab').classList.add('active');
        }

        function openStockModal() { document.getElementById('stockModal').classList.add('active'); }
        function closeStockModal() { document.getElementById('stockModal').classList.remove('active'); document.getElementById('newStockName').value=''; document.getElementById('newStockPercent').value=''; }
        function openSavingModal() { document.getElementById('savingModal').classList.add('active'); }
        function closeSavingModal() { document.getElementById('savingModal').classList.remove('active'); document.getElementById('newSavingName').value=''; document.getElementById('newSavingAmount').value=''; }

        async function addStock() {
            const name = document.getElementById('newStockName').value.trim();
            const percent = parseFloat(document.getElementById('newStockPercent').value) || 0;
            if (name && percent > 0) {
                const { data } = await db.from('stocks').insert({ user_id: currentUser.id, name, percent, icon: 'default', sort_order: state.stocks.length }).select().single();
                if (data) state.stocks.push({ id: data.id, name, percent, icon: 'default' });
                closeStockModal(); updateUI();
            }
        }

        async function addSaving() {
            const name = document.getElementById('newSavingName').value.trim();
            const amount = parseInt(document.getElementById('newSavingAmount').value) || 0;
            if (name && amount > 0) {
                const { data } = await db.from('savings').insert({ user_id: currentUser.id, name, amount, sort_order: state.savings.length }).select().single();
                if (data) state.savings.push({ id: data.id, name, amount });
                closeSavingModal(); updateUI();
            }
        }

        async function completePurchase(type) {
            const today = new Date().toISOString().split('T')[0];
            const month = new Date().getMonth() + 1;
            const { investAmount, savingAmount } = calculateAmounts();

            if (type === 'invest') {
                const recs = state.stocks.map(s => ({ user_id: currentUser.id, date: today, type: 'invest', item: s.name, amount: Math.round(investAmount * s.percent / 100), rate: state.exchangeRate, memo: 'ìë™ë§¤ìˆ˜' })).filter(r => r.amount > 0);
                const { data } = await db.from('records').insert(recs).select();
                if (data) data.forEach(r => state.records.unshift({ id: r.id, date: r.date, type: r.type, item: r.item, amount: r.amount, rate: parseFloat(r.rate), memo: r.memo }));
                alert(`ğŸ’ ${month}ì›” íˆ¬ì ë§¤ìˆ˜ ì™„ë£Œ!\nì´ ${formatNumber(investAmount)}ì›`);
            } else {
                const recs = state.savings.map(s => ({ user_id: currentUser.id, date: today, type: 'saving', item: s.name, amount: s.amount, rate: null, memo: 'ìë™ë§¤ìˆ˜' })).filter(r => r.amount > 0);
                const { data } = await db.from('records').insert(recs).select();
                if (data) data.forEach(r => state.records.unshift({ id: r.id, date: r.date, type: r.type, item: r.item, amount: r.amount, rate: null, memo: r.memo }));
                alert(`ğŸ¦ ${month}ì›” ì ê¸ˆ ì™„ë£Œ!\nì´ ${formatNumber(state.savings.reduce((s,x)=>s+x.amount,0))}ì›`);
            }
            state.selectedMonth = month; updateUI();
        }

        function updateManualItemSelect() {
            const type = document.getElementById('manualType').value;
            const wrapper = document.getElementById('manualItemWrapper');
            // selectë¡œ ë³µì›
            wrapper.innerHTML = '<select class="manual-input" id="manualItem" onchange="checkCustomInput()"></select>';
            const sel = document.getElementById('manualItem');
            
            let options = '<option value="">ì„ íƒ</option>';
            if (type === 'saving') {
                // ì ê¸ˆ í•­ëª© ëª©ë¡
                state.savings.forEach(s => {
                    options += `<option value="${s.name}">${s.name}</option>`;
                });
            } else {
                // ì£¼ì‹/ì½”ì¸ - ëª¨ë“  íˆ¬ì ì¢…ëª© í‘œì‹œ
                state.stocks.forEach(s => {
                    options += `<option value="${s.name}">${s.name}</option>`;
                });
            }
            options += '<option value="__custom__">ì§ì ‘ ì…ë ¥...</option>';
            sel.innerHTML = options;
        }

        function checkCustomInput() {
            const sel = document.getElementById('manualItem');
            if (sel && sel.value === '__custom__') {
                const wrapper = document.getElementById('manualItemWrapper');
                wrapper.innerHTML = `<div style="display:flex;gap:8px;align-items:center;">
                    <input type="text" class="manual-input" id="manualItemCustom" placeholder="ì¢…ëª©/í•­ëª©ëª… ì§ì ‘ ì…ë ¥" style="flex:1;">
                    <button type="button" onclick="resetManualItemSelect()" style="background:#333;border:none;color:#888;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;">ì·¨ì†Œ</button>
                </div>`;
                document.getElementById('manualItemCustom').focus();
            }
        }

        function resetManualItemSelect() {
            updateManualItemSelect();
        }

        async function addManualRecord() {
            const date = document.getElementById('manualDate').value;
            const typeSelect = document.getElementById('manualType').value;
            const customInput = document.getElementById('manualItemCustom');
            const selectInput = document.getElementById('manualItem');
            let item = customInput ? customInput.value.trim() : (selectInput ? selectInput.value : '');
            const amount = parseInt(document.getElementById('manualAmount').value) || 0;
            const memo = document.getElementById('manualMemo').value.trim();

            if (!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!item || item === '__custom__') { alert('ì¢…ëª©/í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (amount <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            // ì£¼ì‹/ì½”ì¸ì€ invest, ì ê¸ˆì€ savingìœ¼ë¡œ ì €ì¥
            const type = (typeSelect === 'stock' || typeSelect === 'coin') ? 'invest' : 'saving';
            const typeLabel = typeSelect === 'stock' ? 'ì£¼ì‹' : (typeSelect === 'coin' ? 'ì½”ì¸' : 'ì ê¸ˆ');

            const { data } = await db.from('records').insert({ user_id: currentUser.id, date, type, item, amount, rate: type==='invest' ? state.exchangeRate : null, memo: memo || `ìˆ˜ê¸°ì…ë ¥(${typeLabel})` }).select().single();
            if (data) state.records.unshift({ id: data.id, date: data.date, type: data.type, item: data.item, amount: data.amount, rate: data.rate ? parseFloat(data.rate) : null, memo: data.memo });

            state.selectedMonth = new Date(date).getMonth() + 1;
            document.getElementById('manualAmount').value = '';
            document.getElementById('manualMemo').value = '';
            updateManualItemSelect(); // selectë¡œ ë³µì›
            alert(`âœï¸ ${typeLabel} ê¸°ë¡ ì¶”ê°€!\n${item}: ${formatNumber(amount)}ì›`);
            updateUI();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('salaryInput').addEventListener('input', function(e) { state.salary = parseNumber(e.target.value); e.target.value = formatNumber(state.salary); saveSettings(); updateUI(); });
        document.getElementById('investRatio').addEventListener('input', function(e) { state.investRatio = parseFloat(e.target.value); saveSettings(); updateUI(); });
        document.getElementById('savingRatio').addEventListener('input', function(e) { state.savingRatio = parseFloat(e.target.value); saveSettings(); updateUI(); });
        document.getElementById('investRatioValue').addEventListener('change', function(e) { state.investRatio = Math.max(0, Math.min(100, parseFloat(e.target.value.replace('%',''))||0)); saveSettings(); updateUI(); });
        document.getElementById('savingRatioValue').addEventListener('change', function(e) { state.savingRatio = Math.max(0, Math.min(100, parseFloat(e.target.value.replace('%',''))||0)); saveSettings(); updateUI(); });

        // ì´ˆê¸°í™”
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        document.getElementById('manualDate').value = new Date().toISOString().split('T')[0];
        checkAuth();
    </script>
</body>
</html>
